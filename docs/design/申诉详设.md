# 申诉详细设计

> 本文档严格遵循《详细设计模板》编写，旨在对申诉业务的实现方案进行结构化、规范化、可追溯的详细设计，便于开发、测试、运维等相关人员理解和落地。

## 一、业务分析

> 本章节用于梳理申诉业务的核心概念、业务流程、领域模型和系统能力，为后续详细设计提供业务基础。

### 1. 名词定义
> 本节定义申诉相关的核心名词，介绍名词含义和典型案例，便于统一理解。

|名词|含义|举例|
|-----|-----|---|
| 申诉单 | 记录并管理用户发起的所有申诉事项的聚合根对象 | 某用户发起一条申诉，系统生成一条申诉记录 |
| 申诉项 | 申诉单下具体的申诉明细，支持多类型申诉 | 一条申诉单下有多个申诉项，分别可以申诉不同类型 |
| 申诉类型 | 申诉项的类型及名称，区分不同申诉业务 | 费用、重量、目的地申诉等类型 |
| 申诉方 | 发起申诉的主体，可为网点、中心等 | 网点A、中心C作为申诉方发起申诉 |

### 2. 业务流程
> 表达业务流程流转，每个节点均为业务活动（a.b两位数字编码）。
> 使用mermaid流程图，体现全流程主要节点。业务流程的节点，跟能力定义的API能力、容器架构、API设计数字编码一一对应。
> 业务流程严格对应架构图数字编码，体现申诉全流程主要节点。

```mermaid
flowchart LR
    Start([开始流程]) --> A1[1.1 发起申诉]
    A1 -- 录入 --> A2[1.2 增加申诉项]
    A1 -- 导入 --> A3[1.3 下载模板]
    A3 --> A4[1.4 导入申诉明细]
    A4 --> A5[1.5 删除申诉项]
    A2 --> A6[1.6 提交申诉]
    A5 --> A6
    A6 --> A11[3.1 申诉审核查询]
    A11 --> A7[3.2 申诉审核]
    A6 -- 直接查询 --> A9[1.7 查询申诉进展]
    A7 -- 系统审核 --> A8[3.4 审核通知]
    A7 -- 人工审核 --> A8
    A8 --> End([流程结束])
    A9 --> A10[1.8/3.3 查看申诉结果]
    A7-->A10
    A10 --> End
```

### 3. 领域模型
> 本节采用领域驱动设计（DDD），描述核心领域对象及其关系。用ER图表达对象/实体关系，表格列出主要领域对象、类型、关键属性。

|领域对象|对象类型|对象属性|
|---|---|---|
|Appeal（申诉单）|聚合根|id、appealerId（申诉方id）、reason（申诉理由）、status（申诉状态）、attachments（附件列表）、items（申诉项列表）|
|AppealItem（申诉项）|实体|id、type（申诉类型）、code（申诉项编码）、title（申诉项标题）、status（申诉项状态）、content（申诉内容）|
|AppealType（申诉类型）|值对象|type（申诉类型）、title（申诉类型名）|
|Appealer（申诉方）|实体|id、code（申诉方编码）、type（申诉方类型）|

> 领域对象关系ER图：
```mermaid
erDiagram
    Appeal ||--o{ AppealItem : "1:N"
    AppealItem }o--|| AppealType : "类型"
    Appeal }o--|| Appealer : "申诉方"
    Appeal ||--o{ Evidence : "1:N"
```

### 4. 能力定义
> 本节定义每个业务活动对应的API能力，包括编号、归属系统、功能说明、SLA协议。

|业务活动|归属系统|能力说明|SLA协议|
|---|---|---|---|
|1.1 发起申诉|申诉服务|创建申诉单，录入申诉基础信息（订单号、类型、理由、证据）|TPS 200<br/>TP95 150ms<br/>TP99 300ms|
|1.2 增加申诉项|申诉服务|为申诉单添加申诉项（类型、内容）|TPS 300<br/>TP95 100ms<br/>TP99 200ms|
|1.3 下载模板|申诉服务/文件存储|下载申诉明细导入模板|QPS 100<br/>TP95 150ms<br/>TP99 300ms|
|1.4 导入申诉明细|申诉服务|批量导入申诉项明细（文件上传、校验、入库）|TPS 100<br/>TP95 200ms<br/>TP99 350ms|
|1.5 删除申诉项|申诉服务|删除指定申诉项|TPS 300<br/>TP95 100ms<br/>TP99 200ms|
|1.6 提交申诉|申诉服务|提交申诉单，进入审核流程|TPS 100<br/>TP95 100ms<br/>TP99 250ms|
|3.1 申诉审核查询|申诉服务|查询待审核申诉单及明细|QPS 100<br/>TP95 100ms<br/>TP99 200ms|
|3.2 申诉审核|申诉服务|系统/人工审核申诉单及项，记录审核意见|TPS 150<br/>TP95 100ms<br/>TP99 200ms|
|3.4 审核通知|申诉服务/MQ|申诉审核结果异步通知（MQ推送）|TPS 300<br/>TP95 50ms<br/>TP99 200ms|
|1.7 查询申诉进展|申诉服务|查询申诉单处理进展|QPS 200<br/>TP95 200ms<br/>TP99 400ms|
|1.8/3.3 查看申诉结果|申诉服务|查询申诉单最终审核结果|QPS 300<br/>TP95 150ms<br/>TP99 300ms|

## 二、详细设计

> 本章节对申诉系统的技术实现进行详细设计，包括容器架构、API设计、逻辑模型、数据模型等，确保设计可落地、可维护、可扩展。

### 1. 容器架构
> 介绍分别有那些容器，各容器的职责。
> 介绍依赖外部哪些容器。
> 用Mermaid C4 Container图描述系统各容器及交互关系。
> Person跟Container的Rel用业务活动，a.b两位数字编码；Container之间的Rel用业务任务，a.b.c三位数字编码。
> 业务流程、活动与业务流程图、能力定义编号保持一致。

#### 服务划分
> 说明各容器的功能职责。

- 申诉APP（前端）：提供用户申诉入口、申诉项管理、进度与结果查询等界面，基于Vue/React实现。
- 申诉服务：负责申诉单全生命周期管理、流程编排、状态流转、审核处理，基于Spring Boot实现。
- 文件存储：用于存储申诉相关的附件、模板等文件，支持文件上传、下载、读取。
- 申诉数据库：持久化存储申诉单、申诉项等核心业务数据，采用MySQL。
- 申诉通知（MQ）：通过RocketMQ实现申诉归档、审核通知等异步消息推送。
- 收单服务：对接收单/计费相关业务，提供凭证查询、计费申诉等能力。

#### 外部依赖
> 说明依赖的外部系统。

- 文件存储：用于申诉材料、模板等文件的上传与下载。
- 收单服务：提供计费、凭证等外部业务能力对接。

#### 架构图
> Person跟Container的Rel用业务活动
> Container之间的Rel用业务步骤
> C4容器图，展示系统各容器及主要交互

```mermaid
C4Container

Person(site, "网点/中心")
Person(user, "管区/总部")
Person_Ext(system, "系统Job")

Container_Boundary(c1, "申诉系统") {
    Container(web, "申诉APP", "Vue/React", "申诉操作界面")
    Container(app, "申诉服务", "Spring Boot", "申诉处理服务")
    ContainerDb_Ext(fs, "文件存储", "File System", "文件/目录")
    ContainerDb(db, "申诉数据库", "MySQL", "申诉单/申诉项")
    ContainerQueue(mq, "申诉通知", "RocketMQ", "申诉归档/通知")
    Container_Ext(billing, "收单服务", "Spring Boot", "收单/计费")
}

Rel(site, web, "1.1 发起申诉<br/>1.2 增加申诉项<br/>1.3 下载模板<br/>1.4 导入申诉明细<br/>1.5 删除申诉项<br/>1.6 提交申诉<br/>1.7 查询申诉进展<br/>1.8 查看申诉结果")
UpdateRelStyle(site, web, $offsetX="-60", $offsetY="-50")

Rel(system, app, "2.1 验证申诉")
UpdateRelStyle(system, app, $offsetX="0", $offsetY="-50")
Rel(user, web, "3.1 申诉审核查询<br/>3.2 申诉审核<br/>3.3 查看申诉结果")
UpdateRelStyle(user, web, $offsetX="0", $offsetY="-50")

Rel_D(web, app, "REST API调用")
UpdateRelStyle(web, app, $offsetX="-35", $offsetY="0")

Rel_D(app, db, "1.1.1 创建申诉单<br/>1.2.1/1.4.3 增加申诉项<br/>1.3.1 文件下载模板<br/>1.5.1 删除申诉项<br/>1.7.1 查询申诉进展<br/>1.8.1/3.3.1 查看申诉结果<br/>2.1.2 验证申诉项<br/>1.1.3/1.4.3 更新申诉单<br/>3.2.1 审批申诉单<br/>3.2.2 审批申诉项")
UpdateRelStyle(app, db, $offsetX="-70", $offsetY="0")

Rel_D(app, fs, "1.3.1 文件下载模板<br/>1.4.1 文件上传<br/>1.4.2 文件读取")
UpdateRelStyle(app, fs, $offsetX="-40", $offsetY="0")

Rel_D(app, mq, "3.4 审核通知")
UpdateRelStyle(app, mq, $offsetX="-40", $offsetY="0")

Rel_D(app, billing, "1.1.2/2.1.1 查询凭证<br/>3.4.1 通知收单")
UpdateRelStyle(app, billing, $offsetX="-40", $offsetY="0")

UpdateLayoutConfig($c4ShapeInRow="3", $c4BoundaryInRow="1")
```

### 2. API设计
> 详细设计业务活动对应的API能力，关键任务对应业务任务。
> 每个接口用表格描述，字段包括API签名、请求参数、响应结果、关键任务（编号）、状态和异常。
> api用做二方服务，service用作内部服务，open用开放服务。
> API的编码主要参考该部分设计。

|API事项|具体说明|
|----|----|
|API名称|1.1 发起申诉|
|API签名|`com.{company}.{business}.appeal.api.AppealService.create`|
|请求参数|`{"reason":"申诉原因", "appealItem":{"appealCode":"申诉项标识","appealType":"重量｜费用","content":{"weigth":2.0, "fee":4.5}}}`|
|响应结果|`{"appealId":"","status":"已受理"}`|
|关键步骤|- 1.1.1 创建申诉单<br/>- 1.1.2 查询凭证<br/>- 1.1.3 更新申诉单|
|状态和异常|400、500|

|API事项|具体说明|
|----|----|
|API名称|1.2 增加申诉项|
|API签名|`com.{company}.{business}.appeal.api.AppealService.addItem`|
|请求参数|`{"appealId":"申诉单id","appealItem":{"appealCode":"申诉项标识","appealType":"重量｜费用","content":{"weigth":2.0, "fee":4.5}}}`|
|响应结果|`{"appealId":"申诉单id","appealItemId":"申诉项id"}`|
|关键步骤|- 1.2.1 增加申诉项|
|状态和异常|400、404、500|

|API事项|具体说明|
|----|----|
|API名称|1.3 下载模板|
|API签名|`com.{company}.{business}.appeal.api.AppealTemplateService.download`|
|请求参数|`{"templateType":""}`|
|响应结果|模板文件流|
|关键步骤|- 1.3.1 文件下载模板|
|状态和异常|404、500|

|API事项|具体说明|
|----|----|
|API名称|1.4 导入申诉明细|
|API签名|`com.{company}.{business}.appeal.api.AppealService.importItems`|
|请求参数|`{"appealId":"申诉单id","file":"文件"}`|
|响应结果|`{"importResult":"success/fail","failItems":[]}`|
|关键步骤|- 1.4.1 文件上传<br/>- 1.4.2 文件读取<br/>- 1.4.3 增加申诉项|
|状态和异常|400、500|

|API事项|具体说明|
|----|----|
|API名称|1.5 删除申诉项|
|API签名|`com.{company}.{business}.appeal.api.AppealService.deleteItem`|
|请求参数|`{"appealId":"申诉单id","appealItemId":"申诉项id"}`|
|响应结果|`{"result":"success/fail"}`|
|关键步骤|- 1.5.1 删除申诉项|
|状态和异常|400、404、500|

|API事项|具体说明|
|----|----|
|API名称|1.6 提交申诉|
|API签名|`com.{company}.{business}.appeal.api.AppealService.submit`|
|请求参数|`{"appealId":""}`|
|响应结果|`{"result":"success/fail","status":"审核中"}`|
|关键步骤|- 1.6.1 提交申诉|
|状态和异常|400、404、500|

|API事项|具体说明|
|----|----|
|API名称|2.1 验证申诉|
|API签名|`com.{company}.{business}.appeal.api.AppealService.validate`|
|请求参数|`{"appealId":"","items":[{"itemId":"","type":"","content":""}]}`|
|响应结果|`{"result":"success/fail","invalidItems":[{"itemId":"","reason":""}]}`|
|关键步骤|- 2.1.1 查询凭证<br/>- 2.1.2 验证申诉项|
|状态和异常|400、404、500|

|API事项|具体说明|
|----|----|
|API名称|1.7 查询申诉进展|
|API签名|`com.{company}.{business}.appeal.api.AppealService.progress`|
|请求参数|`{"appealId":""}`|
|响应结果|`{"progress":[]}`|
|关键步骤|- 1.7.1 查询申诉进展|
|状态和异常|404、500|

|API事项|具体说明|
|----|----|
|API名称|1.8 查看申诉结果/3.1 申诉审核查询/3.3 查看申诉结果|
|API签名|`com.{company}.{business}.appeal.api.AppealService.query`|
|请求参数|`{"status":"待审核/已审核","page":1,"size":20}`|
|响应结果|`{"appeals":[{"appealId":"","appealItems":{"itemId":1,"code":"","type":""},"status":""}],"total":100}`|
|关键步骤|- 3.1.1 查询待审核申诉单|
|状态和异常|400、500|

|API事项|具体说明|
|----|----|
|API名称|3.2 申诉审核|
|API签名|`com.{company}.{business}.appeal.api.AppealService.audit`|
|请求参数|`{"appealId":"","auditOpinion":"","result":"通过/驳回"}`|
|响应结果|`{"result":"success/fail","status":"已完成/驳回"}`|
|关键步骤|- 3.2.1 审批申诉单<br/>- 3.2.2 审批申诉项|
|状态和异常|400、404、500|

|API事项|具体说明|
|----|----|
|API名称|3.4 审核通知|
|Topic|`{business}_appeal_event_topic`|
|请求参数|`{"appealId":"", "approvedItems":[],"rejectedItems":[]}`|
|响应结果|`{"result":"success/fail"}`|
|关键步骤|- 3.4.1 通知收单|
|状态和异常|500|

### 3. 逻辑模型
> 基于领域模型设计的关键领域对象，用类和属性表达。
> 采用mermaid协议的类图。
> 领域模型的编码主要参考该部分设计。

#### 关键类图
```mermaid
classDiagram
    class Appeal {
        +Long id
        +Long appealerId
        +String reason
        +String status
        +List~String~ attachments
        +List~AppealItem~ items
    }
    class AppealItem {
        +Long id
        +String type
        +String title
        +String status
        +String content
    }
    class AppealType {
        +String type
        +String title
    }
    class Appealer {
        +Long id
        +String code
        +String type
    }
    Appeal "1" o-- "1" Appealer : 申诉方
    Appeal "1" o-- "*" AppealItem : 包含
    AppealType  "1" o-- "*" AppealItem : 类型
   
```
#### 状态流转
> 定义聚合根或实体的状态机，描述对象状态流转。
> 采用mermaid协议的状态图，对象状态机的编码主要参考该部分，状态值采用状态码枚举表达。

##### 申诉单状态机
```mermaid
stateDiagram-v2
    [*] --> 已创建
    已创建 --> 已验证 : 校验通过
    已验证 --> 已受理 : 申诉提交
    已受理 --> 审核中 : 进入审核
    审核中 --> 全部通过 : 所有过
    审核中 --> 部分通过 : 部分通过
    审核中 --> 全部驳回 : 所有驳回
    已创建 --> 已取消 : 用户撤销
    已验证 --> 已取消 : 用户撤销
    已受理 --> 已取消 : 用户撤销
    审核中 --> 已取消 : 用户撤销
    全部通过 --> [*]
    部分通过 --> [*]
    全部驳回 --> [*]
    已取消 --> [*]
```

> - "已创建"是申诉单初始状态，后续经系统校验进入"已验证"，再由受理人确认进入"已受理"。
> - "审核中"可流转为"全部通过""部分通过""全部驳回"三种结果，均可进入"已完成"终态。
> - 用户可在"已创建""已验证""已受理""审核中"任一阶段撤销申诉，进入"已取消"终态。

##### 申诉项状态机

```mermaid
stateDiagram-v2
    [*] --> 已创建
    已创建 --> 验证通过 : 校验通过
    已创建 --> 验证失败 : 校验失败
    已创建 --> 验证驳回 : 校验驳回
    验证通过 --> 待审核 : 进入审核
    待审核 --> 审核通过 : 审核通过
    待审核 --> 审核驳回 : 审核驳回
    验证失败 --> [*]
    验证驳回 --> [*]
    审核通过 --> [*]
    审核驳回 --> [*]
```
 
> - "已创建"为申诉项初始状态，系统校验后可进入"验证通过""验证失败"或"验证驳回"。
> - "验证通过"后进入"待审核"，再由审核流转为"审核通过"或"审核驳回"。
> - "验证失败""验证驳回""审核通过""审核驳回"均为终态。

#### 处理时序
> 定义每个API的处理时序，每个API都有独立时序图。
> 重点突出关键任务的先后顺序和分层处理机制。
> 按用户接口、应用服务、领域服务、基础设施分层，表达一个API接口实现的具体过程。
> 应用服务、领域服务、基础设施的编码，主要参考该部分设计。

##### 1.1 发起申诉
```mermaid
sequenceDiagram
    participant U as 用户
    participant API as 用户接口
    participant APP as 应用服务
    participant DOMAIN as 领域服务
    participant INFRA as 基础设施
    participant B as 收单服务
    participant DB as 数据库
    U->>API: 1.1 发起申诉
    API->>APP: 1.1 发起申诉
    APP->>DOMAIN: 1.1.1 创建申诉单
    DOMAIN->>INFRA: 持久化申诉单
    INFRA->>DB: 插入申诉单
    APP->>DOMAIN: 1.1.2 补充要素
    DOMAIN->>INFRA: 查询凭证
    INFRA->>B: 查询凭证
    APP->>DOMAIN: 1.1.3 更新申诉单
    DOMAIN->>INFRA: 更新持久化
    INFRA->>DB: 更新申诉单
    APP-->>API: 返回申诉单
    API-->>U: 返回申诉单信息
```

##### 1.2 增加申诉项
```mermaid
sequenceDiagram
    participant U as 用户
    participant API as 用户接口
    participant APP as 应用服务
    participant DOMAIN as 领域服务
    participant INFRA as 基础设施
    participant DB as 数据库
    U->>API: 1.2 增加申诉项
    API->>APP: 1.2 增加申诉项
    APP->>DOMAIN: 1.2.1 创建申诉项
    DOMAIN->>INFRA: 持久化申诉项
    INFRA->>DB: 插入申诉项
    APP-->>API: 返回申诉项
    API-->>U: 返回结果
```

##### 1.3 下载模板
```mermaid
sequenceDiagram
    participant U as 用户
    participant API as 用户接口
    participant APP as 应用服务
    participant DOMAIN as 领域服务
    participant INFRA as 基础设施
    participant F as 文件存储
    U->>API: 1.3 下载模板
    API->>APP: 1.3 下载模板
    APP->>DOMAIN: 1.3.1 获取模板
    DOMAIN->>INFRA: 文件下载请求
    INFRA->>F: 1.3.1 获取模板文件
    INFRA-->>DOMAIN: 返回模板文件
    DOMAIN-->>APP: 返回模板文件
    APP-->>API: 返回模板文件
    API-->>U: 下载模板
```

##### 1.4 导入申诉明细
```mermaid
sequenceDiagram
    participant U as 用户
    participant API as 用户接口
    participant APP as 应用服务
    participant DOMAIN as 领域服务
    participant INFRA as 基础设施
    participant F as 文件存储
    participant B as 收单服务
    participant DB as 数据库
    U->>API: 1.4 导入申诉明细
    API->>APP: 1.4 导入申诉明细
    APP->>DOMAIN: 1.4.1 文件上传
    DOMAIN->>INFRA: 上传文件
    INFRA->>F: 上传文件
    APP->>DOMAIN: 1.4.2 文件读取
    DOMAIN->>INFRA: 文件读取
    INFRA->>F: 流式读取
    opt 并发处理
    APP->>DOMAIN: 1.4.3 增加申诉项
    DOMAIN->>INFRA: 持久化申诉项
    INFRA->>DB: 插入申诉项
    end
    APP-->>API: 返回导入结果
    API-->>U: 展示导入结果
```

##### 1.5 删除申诉项
```mermaid
sequenceDiagram
    participant U as 用户
    participant API as 用户接口
    participant APP as 应用服务
    participant DOMAIN as 领域服务
    participant INFRA as 基础设施
    participant DB as 数据库
    U->>API: 1.5 删除申诉项
    API->>APP: 1.5 删除申诉项
    APP->>DOMAIN: 1.5.1 删除申诉项
    DOMAIN->>INFRA: 删除申诉项
    INFRA->>DB: 删除申诉项
    APP-->>API: 返回删除结果
    API-->>U: 展示结果
```

##### 1.6 提交申诉
```mermaid
sequenceDiagram
    participant U as 用户
    participant API as 用户接口
    participant APP as 应用服务
    participant DOMAIN as 领域服务
    participant INFRA as 基础设施
    participant DB as 数据库
    U->>API: 1.6 提交申诉
    API->>APP: 1.6 提交申诉
    APP->>DOMAIN: 1.6.1 提交申诉
    DOMAIN->>INFRA: 更新申诉单状态
    INFRA->>DB: 更新申诉单
    APP-->>API: 返回提交结果
    API-->>U: 展示结果
```

##### 2.1 验证申诉
```mermaid
sequenceDiagram
    participant SYS as Job
    participant API as 用户接口
    participant APP as 应用服务
    participant DOMAIN as 领域服务
    participant INFRA as 基础设施
    participant B as 收单服务
    participant DB as 数据库
    SYS->>API: 2.1 验证申诉
    API->>APP: 2.1 验证申诉
    opt 并发处理
    APP->>DOMAIN: 2.1.1 查询凭证
    DOMAIN->>INFRA: 查询凭证
    INFRA->>B: 查询凭证
    APP->>DOMAIN: 2.1.2 验证申诉项
    DOMAIN->>INFRA: 校验申诉项
    INFRA->>DB: 查询/校验数据
    end
    APP-->>API: 返回验证结果
```

##### 3.1 申诉审核查询
```mermaid
sequenceDiagram
    participant A as 审核员
    participant API as 用户接口
    participant APP as 应用服务
    participant DOMAIN as 领域服务
    participant INFRA as 基础设施
    participant DB as 数据库
    A->>API: 3.1 申诉审核查询
    API->>APP: 3.1 申诉审核查询
    APP->>DOMAIN: 3.1.1 查询待审核申诉单
    DOMAIN->>INFRA: 查询待审核申诉单
    INFRA->>DB: 查询数据
    APP-->>API: 返回数据
    API-->>A: 展示列表
```

##### 3.2 申诉审核
```mermaid
sequenceDiagram
    participant A as 审核员
    participant API as 用户接口
    participant APP as 应用服务
    participant DOMAIN as 领域服务
    participant INFRA as 基础设施
    participant DB as 数据库
    participant MQ as 消息队列
    API->>APP: 3.2 申诉审核
    alt 按申诉单审批
    APP->>DOMAIN: 3.2.1 审批申诉单
    DOMAIN->>INFRA: 审批申诉单
    opt 事务处理
    INFRA->>DB: 更新申诉单
    INFRA->>DB: 更新申诉项
    end
    else 按申诉项审批
    APP->>DOMAIN: 3.2.2 审批申诉项
    DOMAIN->>INFRA: 审批申诉项
    opt 事务处理
    INFRA->>DB: 更新申诉项
    INFRA->>DB: 更新申诉单
    end
    end
    APP->>DOMAIN: 3.2.3 申诉通知
    DOMAIN->>INFRA: 申诉通知
    INFRA->>MQ: 发送通知
    APP-->>API: 返回审核结果
    API-->>A: 展示审核结果
```

##### 3.3 查看申诉结果
```mermaid
sequenceDiagram
    participant U as 用户/审核员
    participant API as 用户接口
    participant APP as 应用服务
    participant DOMAIN as 领域服务
    participant INFRA as 基础设施
    participant DB as 数据库
    U->>API: 3.3 查看申诉结果
    API->>APP: 3.3 查看申诉结果
    APP->>DOMAIN: 3.3.1 查询申诉审核结果
    DOMAIN->>INFRA: 查询申诉结果
    INFRA->>DB: 查询数据
    APP-->>API: 返回结果
    API-->>U: 展示结果
```

##### 3.4 审核通知
```mermaid
sequenceDiagram
    participant M as MQ
    participant API as 用户接口 
    participant APP as 应用服务
    participant DOMAIN as 领域服务
    participant INFRA as 基础设施
    participant B as 收单服务
    M-->>API: 3.4 申诉通知
    API->>APP: 3.4 申诉通知
    APP->>DOMAIN: 3.4.1 申诉成功通知
    DOMAIN->>INFRA: 申诉成功通知
    INFRA->>B: 通知收单
    APP-->>API: 处理结果
    API-->>M: 通知完成
```

##### 1.7 查询申诉进展
```mermaid
sequenceDiagram
    participant U as 用户
    participant API as 用户接口
    participant APP as 应用服务
    participant DOMAIN as 领域服务
    participant INFRA as 基础设施
    participant DB as 数据库
    U->>API: 1.7 查询申诉进展
    API->>APP: 1.7 查询申诉进展
    APP->>DOMAIN: 1.7.1 查询进展
    DOMAIN->>INFRA: 查询进展
    INFRA->>DB: 查询数据
    APP-->>API: 返回进展
    API-->>U: 展示进展
```

##### 1.8 查看申诉结果
```mermaid
sequenceDiagram
    participant U as 用户
    participant API as 用户接口
    participant APP as 应用服务
    participant DOMAIN as 领域服务
    participant INFRA as 基础设施
    participant DB as 数据库
    U->>API: 1.8 查看申诉结果
    API->>APP: 1.8 查看申诉结果
    APP->>DOMAIN: 1.8.1 查询结果
    DOMAIN->>INFRA: 查询结果
    INFRA->>DB: 查询数据
    APP-->>API: 返回结果
    API-->>U: 展示结果
```

### 4. 数据模型
> 定义主要的表实体ER关系和表结构。
> 数据实体、存储Mapper的编码，主要参考该部分设计。

#### ER关系
```mermaid
erDiagram
    Appeal ||--o{ AppealItem : "1:N"
    Appeal }o--|| Appealer : "申诉方"
```

#### 表结构
```sql
-- 申诉单
CREATE TABLE `appeal` (
    `id` bigint NOT NULL PRIMARY KEY COMMENT '申诉单ID',
    `appealer_id` bigint NOT NULL COMMENT '申诉方ID',
    `reason` varchar(255) COMMENT '申诉理由',
    `status` varchar(20) NOT NULL COMMENT '申诉状态',
    `attachments` json COMMENT '附件列表'
);

-- 申诉项
CREATE TABLE `appeal_item` (
    `id` bigint NOT NULL PRIMARY KEY COMMENT '申诉项ID',
    `appeal_id` bigint NOT NULL COMMENT '申诉单ID',
    `type` varchar(20) NOT NULL COMMENT '申诉类型编码',
    `title` varchar(100) COMMENT '申诉项标题',
    `status` varchar(20) NOT NULL COMMENT '申诉项状态',
    `content` varchar(255) COMMENT '申诉内容'
);

-- 申诉方
CREATE TABLE `appealer` (
    `id` bigint NOT NULL PRIMARY KEY COMMENT '申诉方ID',
    `code` varchar(50) NOT NULL COMMENT '申诉方编码',
    `type` varchar(20) NOT NULL COMMENT '申诉方类型'
);

三、编码参考
参考 @coding-guidelines.mdc 的设定